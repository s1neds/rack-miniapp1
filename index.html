<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rack Manager</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: var(--tg-theme-bg-color, #f5f5f5);
            color: var(--tg-theme-text-color, #000000);
            padding: 16px;
            padding-bottom: 80px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .title {
            font-size: 24px;
            font-weight: bold;
        }
        .add-button {
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(64, 167, 227, 0.3);
        }
        .rack-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            padding: 8px;
            border-radius: 12px;
        }
        .rack-tab {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .rack-tab.active {
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        .rack-view {
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 20px;
        }
        .units-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-top: 16px;
        }
        .unit {
            aspect-ratio: 1;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .unit.free {
            background: var(--tg-theme-hint-color, #e0e0e0);
            color: var(--tg-theme-text-color, #000000);
            opacity: 0.3;
        }
        .unit.occupied {
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        .unit:hover { transform: scale(1.05); }
        .servers-list { margin-top: 20px; }
        .server-card {
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .server-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 8px;
        }
        .server-name {
            font-size: 18px;
            font-weight: 600;
        }
        .server-location {
            color: var(--tg-theme-hint-color, #666666);
            font-size: 14px;
            margin-bottom: 8px;
        }
        .server-details {
            display: flex;
            gap: 12px;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666666);
        }
        .delete-btn {
            background: none;
            border: none;
            color: #ff3b30;
            font-size: 20px;
            cursor: pointer;
            padding: 4px 8px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            padding: 16px;
            z-index: 1000;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            border-radius: 16px;
            padding: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 16px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 4px;
            color: var(--tg-theme-hint-color, #666666);
            font-size: 14px;
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 8px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
        }
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }
        .modal-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 20px;
        }
        .modal-button {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        .modal-button.primary {
            background: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
        }
        .modal-button.secondary {
            background: var(--tg-theme-hint-color, #e0e0e0);
            color: var(--tg-theme-text-color, #000000);
        }
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--tg-theme-hint-color, #666666);
        }
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }
        .stat-card {
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            padding: 16px;
            border-radius: 12px;
            text-align: center;
        }
        .stat-value {
            font-size: 28px;
            font-weight: bold;
            color: var(--tg-theme-button-color, #40a7e3);
        }
        .stat-label {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666666);
            margin-top: 4px;
        }
        .search-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--tg-theme-hint-color, #e0e0e0);
            border-radius: 8px;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            font-size: 16px;
            margin-bottom: 16px;
        }
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--tg-theme-secondary-bg-color, #ffffff);
            display: flex;
            justify-content: space-around;
            padding: 12px;
            border-top: 1px solid var(--tg-theme-hint-color, #e0e0e0);
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            background: none;
            border: none;
            color: var(--tg-theme-hint-color, #666666);
            font-size: 12px;
            cursor: pointer;
        }
        .nav-item.active {
            color: var(--tg-theme-button-color, #40a7e3);
        }
        .nav-icon { font-size: 20px; }
    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">Rack Manager</h1>
        <button class="add-button" onclick="window.app.openAddModal()">+</button>
    </div>

    <div class="rack-tabs">
        <button class="rack-tab active" onclick="window.app.switchRack('A')">A</button>
        <button class="rack-tab" onclick="window.app.switchRack('B')">B</button>
        <button class="rack-tab" onclick="window.app.switchRack('C')">C</button>
    </div>

    <div id="content">
        <div class="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞ -->
    <div id="serverModal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä</h2>
            <form id="serverForm" onsubmit="window.app.saveServer(event)">
                <input type="hidden" id="serverId">
                
                <div class="form-group">
                    <label>–°—Ç–æ–π–∫–∞</label>
                    <select id="rack" required>
                        <option value="A">A</option>
                        <option value="B">B</option>
                        <option value="C">C</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>–ù–∞—á–∞–ª—å–Ω—ã–π —é–Ω–∏—Ç</label>
                        <input type="number" id="startUnit" min="1" max="49" required>
                    </div>
                    <div class="form-group">
                        <label>–ö–æ–ª-–≤–æ —é–Ω–∏—Ç–æ–≤</label>
                        <input type="number" id="unitsCount" min="1" max="49" value="1" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞</label>
                    <input type="text" id="serverName" required placeholder="H12m1/G41m2">
                </div>
                
                <div class="form-group">
                    <label>IP –∞–¥—Ä–µ—Å</label>
                    <input type="text" id="ipAddress" placeholder="192.168.1.100">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>–õ–æ–≥–∏–Ω</label>
                        <input type="text" id="login">
                    </div>
                    <div class="form-group">
                        <label>–ü–∞—Ä–æ–ª—å</label>
                        <input type="text" id="password">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>–°—Ç–∞—Ç—É—Å –ø–∏—Ç–∞–Ω–∏—è</label>
                    <select id="powerStatus">
                        <option value="üü¢ –í–ö–õ">üü¢ –í–ö–õ</option>
                        <option value="üî¥ –í–´–ö–õ">üî¥ –í–´–ö–õ</option>
                        <option value="‚ö´ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ" selected>‚ö´ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Media Server</label>
                    <select id="mediaServer">
                        <option value="Media160">Media160</option>
                        <option value="Media128">Media128</option>
                        <option value="Media64">Media64</option>
                        <option value="–ù–µ—Ç" selected>–ù–µ—Ç</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>–í–µ–Ω–¥–æ—Ä –¥–∏—Å–∫–æ–≤</label>
                    <select id="diskVendor">
                        <option value="">–ù–µ—Ç –¥–∏—Å–∫–∞</option>
                        <option value="WD">WD</option>
                        <option value="Seagate">Seagate</option>
                        <option value="Toshiba">Toshiba</option>
                    </select>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>–ö–æ–ª-–≤–æ –¥–∏—Å–∫–æ–≤</label>
                        <input type="text" id="diskCount" placeholder="4x">
                    </div>
                    <div class="form-group">
                        <label>–û–±—ä–µ–º</label>
                        <input type="text" id="diskSize" placeholder="1TB">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä –¥–∏—Å–∫–∞</label>
                    <input type="text" id="diskSerial" placeholder="PURPZ">
                </div>
                
                <div class="form-group">
                    <label>–°–µ—Ä–∏–π–Ω—ã–π –Ω–æ–º–µ—Ä —Å–µ—Ä–≤–µ—Ä–∞</label>
                    <input type="text" id="serialNumber">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label>–¢–∏–ø –∑–∞–¥–∞—á–∏</label>
                        <select id="taskType">
                            <option value="">–ù–µ—Ç</option>
                            <option value="REGEX-">REGEX-</option>
                            <option value="xVR-">xVR-</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>–ù–æ–º–µ—Ä –∑–∞–¥–∞—á–∏</label>
                        <input type="text" id="taskNumber">
                    </div>
                </div>
                
                <div class="form-group">
                    <label>–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω—ã–π</label>
                    <input type="text" id="responsible">
                </div>
                
                <div class="form-group">
                    <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                    <textarea id="comment" rows="3"></textarea>
                </div>
                
                <div class="modal-buttons">
                    <button type="button" class="modal-button secondary" onclick="window.app.closeModal()">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="modal-button primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <div class="nav-bar">
        <button class="nav-item active" onclick="window.app.showView('racks')">
            <span class="nav-icon">üè¢</span>
            <span>–°—Ç–æ–π–∫–∏</span>
        </button>
        <button class="nav-item" onclick="window.app.showView('stats')">
            <span class="nav-icon">üìä</span>
            <span>–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
        </button>
        <button class="nav-item" onclick="window.app.showView('search')">
            <span class="nav-icon">üîç</span>
            <span>–ü–æ–∏—Å–∫</span>
        </button>
    </div>

    <script>
        (function() {
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();

            // Firebase config
            const firebaseConfig = {
                apiKey: "AIzaSyBDSftDnPN_gSYzY0Z-dTALNjQe-zXoPsE",
                authDomain: "rack-manager-340bb.firebaseapp.com",
                projectId: "rack-manager-340bb",
                storageBucket: "rack-manager-340bb.firebasestorage.app",
                messagingSenderId: "505606999321",
                appId: "1:505606999321:web:5a36888fb94648f4c2f808",
                measurementId: "G-SF67YME7XH"
            };

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Firebase
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();

            // –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userId = tg.initDataUnsafe?.user?.id || 'anonymous';
            const userName = tg.initDataUnsafe?.user?.first_name || 'User';

            // –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            let currentRack = 'A';
            let currentView = 'racks';
            let servers = [];

            // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            async function loadData() {
                try {
                    const snapshot = await db.collection('servers').get();
                    servers = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    renderView();
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                    servers = [];
                    renderView();
                }
            }

            // –†–µ–Ω–¥–µ—Ä
            function renderView() {
                if (currentView === 'racks') renderRacks();
                else if (currentView === 'stats') renderStats();
                else if (currentView === 'search') renderSearch();
            }

            // –°—Ç–æ–π–∫–∏
            function renderRacks() {
                const rackServers = servers.filter(s => s.rack === currentRack);
                
                const occupiedMap = {};
                rackServers.forEach(server => {
                    for (let u = server.startUnit; u <= server.endUnit; u++) {
                        occupiedMap[u] = server;
                    }
                });

                let unitsHtml = '';
                for (let i = 1; i <= 49; i++) {
                    const server = occupiedMap[i];
                    unitsHtml += `
                        <div class="unit ${server ? 'occupied' : 'free'}" 
                             onclick="window.app.${server ? `editServer('${server.id}')` : `openAddModal(${i})`}">
                            ${server ? 'üì¶' : i}
                        </div>
                    `;
                }

                let serversHtml = '';
                rackServers.sort((a, b) => a.startUnit - b.startUnit).forEach(server => {
                    serversHtml += `
                        <div class="server-card">
                            <div class="server-header">
                                <span class="server-name">${server.serverName || '–ë–µ–∑ –∏–º–µ–Ω–∏'}</span>
                                <button class="delete-btn" onclick="window.app.deleteServer('${server.id}')">üóë</button>
                            </div>
                            <div class="server-location">
                                –Æ–Ω–∏—Ç—ã ${server.startUnit}-${server.endUnit} (${server.unitsCount}U)
                            </div>
                            <div class="server-details">
                                <span>${server.powerStatus || '‚ö´ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</span>
                                <span>üñ• ${server.mediaServer || '–ù–µ—Ç'}</span>
                            </div>
                            ${server.ipAddress ? `<div class="server-details">üåê ${server.ipAddress}</div>` : ''}
                        </div>
                    `;
                });

                document.getElementById('content').innerHTML = `
                    <div class="rack-view">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>–Æ–Ω–∏—Ç—ã 1-49</span>
                            <span>–ó–∞–Ω—è—Ç–æ: ${rackServers.reduce((acc, s) => acc + (s.unitsCount || 1), 0)}U</span>
                        </div>
                        <div class="units-grid">
                            ${unitsHtml}
                        </div>
                    </div>
                    <div class="servers-list">
                        <h3 style="margin-bottom: 12px;">–°–µ—Ä–≤–µ—Ä—ã –≤ —Å—Ç–æ–π–∫–µ ${currentRack}</h3>
                        ${serversHtml || '<p>–ù–µ—Ç —Å–µ—Ä–≤–µ—Ä–æ–≤</p>'}
                    </div>
                `;
            }

            // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            function renderStats() {
                const totalServers = servers.length;
                const totalUnits = servers.reduce((acc, s) => acc + (s.unitsCount || 1), 0);
                
                const rackStats = {};
                ['A', 'B', 'C'].forEach(rack => {
                    const rackServers = servers.filter(s => s.rack === rack);
                    rackStats[rack] = {
                        count: rackServers.length,
                        units: rackServers.reduce((acc, s) => acc + (s.unitsCount || 1), 0)
                    };
                });

                document.getElementById('content').innerHTML = `
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value">${totalServers}</div>
                            <div class="stat-label">–í—Å–µ–≥–æ —Å–µ—Ä–≤–µ—Ä–æ–≤</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value">${totalUnits}</div>
                            <div class="stat-label">–ó–∞–Ω—è—Ç–æ —é–Ω–∏—Ç–æ–≤</div>
                        </div>
                    </div>
                    
                    <div class="rack-view">
                        <h3 style="margin-bottom: 12px;">–ü–æ —Å—Ç–æ–π–∫–∞–º</h3>
                        ${['A', 'B', 'C'].map(rack => `
                            <div style="margin-bottom: 12px;">
                                <div style="display: flex; justify-content: space-between;">
                                    <span>–°—Ç–æ–π–∫–∞ ${rack}</span>
                                    <span>${rackStats[rack].units}/49U</span>
                                </div>
                                <div style="background: var(--tg-theme-hint-color, #e0e0e0); height: 8px; border-radius: 4px; margin-top: 4px;">
                                    <div style="background: var(--tg-theme-button-color, #40a7e3); width: ${(rackStats[rack].units/49)*100}%; height: 8px; border-radius: 4px;"></div>
                                </div>
                                <small>–°–µ—Ä–≤–µ—Ä–æ–≤: ${rackStats[rack].count}</small>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // –ü–æ–∏—Å–∫
            function renderSearch() {
                document.getElementById('content').innerHTML = `
                    <div class="rack-view">
                        <input type="text" class="search-input" id="searchInput" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, IP, –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º—É..." 
                               onkeyup="window.app.searchServers()">
                        <div id="searchResults"></div>
                    </div>
                `;
            }

            function searchServers() {
                const query = document.getElementById('searchInput').value.toLowerCase();
                if (!query) {
                    document.getElementById('searchResults').innerHTML = '';
                    return;
                }

                const results = servers.filter(s => 
                    (s.serverName && s.serverName.toLowerCase().includes(query)) ||
                    (s.ipAddress && s.ipAddress.includes(query)) ||
                    (s.responsible && s.responsible.toLowerCase().includes(query)) ||
                    (s.comment && s.comment.toLowerCase().includes(query))
                );

                let html = '';
                results.slice(0, 20).forEach(server => {
                    html += `
                        <div class="server-card" onclick="window.app.editServer('${server.id}')">
                            <div class="server-name">${server.serverName}</div>
                            <div class="server-location">${server.rack} [${server.startUnit}-${server.endUnit}]</div>
                            ${server.ipAddress ? `<div>üåê ${server.ipAddress}</div>` : ''}
                        </div>
                    `;
                });

                if (results.length === 0) {
                    html = '<p>–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</p>';
                }

                document.getElementById('searchResults').innerHTML = html;
            }

            // –ú–æ–¥–∞–ª–∫–∞
            function openAddModal(startUnit) {
                document.getElementById('modalTitle').textContent = '–î–æ–±–∞–≤–∏—Ç—å —Å–µ—Ä–≤–µ—Ä';
                document.getElementById('serverForm').reset();
                document.getElementById('serverId').value = '';
                document.getElementById('rack').value = currentRack;
                document.getElementById('startUnit').value = startUnit || '';
                document.getElementById('serverModal').classList.add('active');
            }

            function closeModal() {
                document.getElementById('serverModal').classList.remove('active');
            }

            async function editServer(id) {
                const server = servers.find(s => s.id === id);
                if (!server) return;

                document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–µ—Ä';
                document.getElementById('serverId').value = id;
                document.getElementById('rack').value = server.rack || 'A';
                document.getElementById('startUnit').value = server.startUnit || '';
                document.getElementById('unitsCount').value = server.unitsCount || 1;
                document.getElementById('serverName').value = server.serverName || '';
                document.getElementById('ipAddress').value = server.ipAddress || '';
                document.getElementById('login').value = server.login || '';
                document.getElementById('password').value = server.password || '';
                document.getElementById('powerStatus').value = server.powerStatus || '‚ö´ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ';
                document.getElementById('mediaServer').value = server.mediaServer || '–ù–µ—Ç';
                document.getElementById('diskVendor').value = server.diskVendor || '';
                document.getElementById('diskCount').value = server.diskCount || '';
                document.getElementById('diskSize').value = server.diskSize || '';
                document.getElementById('diskSerial').value = server.diskSerial || '';
                document.getElementById('serialNumber').value = server.serialNumber || '';
                document.getElementById('taskType').value = server.taskType || '';
                document.getElementById('taskNumber').value = server.taskNumber || '';
                document.getElementById('responsible').value = server.responsible || '';
                document.getElementById('comment').value = server.comment || '';

                document.getElementById('serverModal').classList.add('active');
            }

            async function saveServer(event) {
                event.preventDefault();
                
                const id = document.getElementById('serverId').value;
                const startUnit = parseInt(document.getElementById('startUnit').value);
                const unitsCount = parseInt(document.getElementById('unitsCount').value);
                
                const serverData = {
                    rack: document.getElementById('rack').value,
                    startUnit: startUnit,
                    endUnit: startUnit + unitsCount - 1,
                    unitsCount: unitsCount,
                    serverName: document.getElementById('serverName').value,
                    ipAddress: document.getElementById('ipAddress').value,
                    login: document.getElementById('login').value,
                    password: document.getElementById('password').value,
                    powerStatus: document.getElementById('powerStatus').value,
                    mediaServer: document.getElementById('mediaServer').value,
                    diskVendor: document.getElementById('diskVendor').value,
                    diskCount: document.getElementById('diskCount').value,
                    diskSize: document.getElementById('diskSize').value,
                    diskSerial: document.getElementById('diskSerial').value,
                    serialNumber: document.getElementById('serialNumber').value,
                    taskType: document.getElementById('taskType').value,
                    taskNumber: document.getElementById('taskNumber').value,
                    responsible: document.getElementById('responsible').value,
                    comment: document.getElementById('comment').value,
                    userId: userId,
                    userName: userName,
                    updatedAt: new Date().toISOString()
                };

                try {
                    if (id) {
                        await db.collection('servers').doc(id).update(serverData);
                    } else {
                        await db.collection('servers').add(serverData);
                    }
                    
                    closeModal();
                    await loadData();
                    tg.HapticFeedback.notification('success');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error);
                    tg.HapticFeedback.notification('error');
                }
            }

            async function deleteServer(id) {
                if (!confirm('–£–¥–∞–ª–∏—Ç—å —Å–µ—Ä–≤–µ—Ä?')) return;
                
                try {
                    await db.collection('servers').doc(id).delete();
                    await loadData();
                    tg.HapticFeedback.notification('success');
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è:', error);
                    tg.HapticFeedback.notification('error');
                }
            }

            function switchRack(rack) {
                currentRack = rack;
                document.querySelectorAll('.rack-tab').forEach((tab, i) => {
                    tab.classList.toggle('active', i === ['A','B','C'].indexOf(rack));
                });
                if (currentView === 'racks') renderView();
            }

            function showView(view) {
                currentView = view;
                document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
                event.target.closest('.nav-item').classList.add('active');
                renderView();
            }

            // –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ window.app
            window.app = {
                switchRack,
                showView,
                openAddModal,
                closeModal,
                saveServer,
                editServer,
                deleteServer,
                searchServers
            };

            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            loadData();
        })();
    </script>
</body>
</html>
